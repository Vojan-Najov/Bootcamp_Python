from bs4 import BeautifulSoup

def exploit():
    input_filename = '../materials/evilcorp.html'
    output_filename = '../materials/evilcorp_hacked.html'

    try:
        with open(input_filename, 'r', encoding='UTF-8') as file:
            html_doc = file.read()
    except Exception as e:
        print(e)
        return

    soup = BeautifulSoup(html_doc, 'html.parser')

    soup.title.string.replace_with('Evil Corp - Stealing your money every day')

    name = soup.find('span', {'class': 'name'}).text.strip()
    h1_tag = soup.new_tag('h1')
    h1_tag.string = f'{name}, you are hacked!'
    soup.body.insert(0, h1_tag)

    script_tag = soup.new_tag('script')
    script_tag.string = '''
        hacked = function() {
            alert('hacked');
        }
        window.addEventListener('load', 
            function() { 
                var f = document.querySelector("form");
                f.setAttribute("onsubmit", "hacked()");
            },
            false
        );
    '''
    soup.body.insert(0, script_tag)

    link = soup.find('a', href='https://mrrobot.fandom.com/wiki/E_Corp')
    link['href'] = 'https://mrrobot.fandom.com/wiki/Fsociety'
    link.string.replace_with('Fsociety')

    print(soup.prettify())

    try:
        with open(output_filename, 'w', encoding='UTF-8') as file:
            file.write(soup.prettify())
    except Exception as e:
        print(e)



if __name__ == '__main__':
    exploit()

        

